
.container-fluid.bg-dark.text-light.footer.pt-5.mt-5.wow.fadeIn(data-wow-delay="0.1s")
    .container.py-5
        .row.g-5
            .col-lg-3.col-md-6
                h4.section-title.ff-secondary.text-start.text-primary.fw-normal.mb-4 Organisatie
                a.btn.btn-link(href="/cookies") Cookie Policy

            .col-lg-3.col-md-6
                h4.section-title.ff-secondary.text-start.text-primary.fw-normal.mb-4 Contact
                p.mb-2
                    i.fa.fa-phone-alt.me-3
                    | +32 412 31 23 25
                p.mb-2
                    i.fa.fa-envelope.me-3
                    | info@dubbelspelgent.com
                .d-flex.pt-2
                    a.btn.btn-outline-light.btn-social(href="https://www.facebook.com/profile.php?id=61584281243243")
                        i.fab.fa-facebook-f

            .col-lg-3.col-md-6
                h4.section-title.ff-secondary.text-start.text-primary.fw-normal.mb-4 Onze Locatie
                p.mb-2
                    i.fa.fa-map-marker-alt.me-3
                    | Blaarmeersen
                    br
                    | Campinglaan 13 Gent
                #map(style="width: 100%; height: 200px; border-radius: 8px;")

    .container
        .copyright
            .row
                .col-md-6.text-center.text-md-start.mb-3.mb-md-0
                    | &copy;
                    a.border-bottom(href="#") https://webtechnologie-labo.vercel.app/
                    | , All Right Reserved.
                    br
                    | Designed By
                    a.border-bottom(href="https://htmlcodex.com") HTML Codex
                    br
                    | Distributed By
                    a.border-bottom(href="https://themewagon.com" target="_blank") ThemeWagon


script(src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js")

// add map
script.
  (function () {
    // CONFIG
    const coords = [51.0443, 3.6881];
    const zoom = 14;
    const maxWaitMs = 10000; // how long to wait for visibility
    const pollIntervalMs = 200;

    // Utility: is element visible and has area?
    function isElementVisible(el) {
      if (!el) return false;
      const style = window.getComputedStyle(el);
      if (style.display === 'none' || style.visibility === 'hidden' || style.opacity === '0') return false;
      const rect = el.getBoundingClientRect();
      // require some visible area and that it's within document dimensions
      if (rect.width <= 0 || rect.height <= 0) return false;
      // optional: ensure not scrolled way out of viewport (but we allow offscreen)
      return true;
    }

    // Wait until the map element is visible or timeout
    function waitForVisible(el, timeoutMs) {
      return new Promise((resolve, reject) => {
        const start = Date.now();
        if (isElementVisible(el)) {
          resolve(true);
          return;
        }
        const id = setInterval(() => {
          if (isElementVisible(el)) {
            clearInterval(id);
            resolve(true);
            return;
          }
          if (Date.now() - start > timeoutMs) {
            clearInterval(id);
            resolve(false); // resolve false rather than reject so we can still try to init
          }
        }, pollIntervalMs);
      });
    }

    // Main init function
    async function initLeafletWhenReady() {
      const mapEl = document.getElementById('map');
      if (!mapEl) {
        console.warn('[map] #map element not found');
        return;
      }

      if (typeof L === 'undefined') {
        console.error('[map] Leaflet (L) not found — make sure leaflet.js is loaded before this script.');
        return;
      }

      console.log('[map] waiting for #map to become visible (max ' + (maxWaitMs/1000) + 's)...');
      const visible = await waitForVisible(mapEl, maxWaitMs);

      if (!visible) {
        console.warn('[map] #map never became visible within timeout. Will still try to initialize but layout may be wrong.');
      } else {
        console.log('[map] #map is visible. Initializing map now.');
      }

      // Ensure we only create once
      if (window._myLeafletMap) {
        console.log('[map] Map instance already exists — skipping init.');
        // ensure correct size
        try { window._myLeafletMap.invalidateSize(true); } catch (e) {}
        return;
      }

      // Create map
      try {
        const map = L.map('map', { scrollWheelZoom: false }).setView(coords, zoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        L.marker(coords).addTo(map).bindPopup('<b>Blaarmeersen</b><br>Campinglaan 13, Gent');

        // store globally so we don't double-init
        window._myLeafletMap = map;

        // Force a couple of resize attempts spaced out to cover slow animations
        setTimeout(() => map.invalidateSize(true), 200);
        setTimeout(() => map.invalidateSize(true), 800);
        setTimeout(() => map.invalidateSize(true), 1600);

        // Also on window resize
        window.addEventListener('resize', () => map.invalidateSize(true));

        console.log('[map] Leaflet initialized successfully.');
      } catch (err) {
        console.error('[map] Failed to initialize Leaflet:', err);
      }
    }

    // Start after DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initLeafletWhenReady);
    } else {
      initLeafletWhenReady();
    }
  })();
